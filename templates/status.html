<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estado del Sistema - Ibiza Info</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding-top: 2rem;
        }
        .status-card {
            transition: all 0.3s ease;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 6px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.12);
        }
        .card-header {
            font-weight: bold;
            padding: 15px 20px;
        }
        .status-ok {
            background-color: #d4edda;
            color: #155724;
        }
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status-neutral {
            background-color: #e2e3e5;
            color: #383d41;
        }
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .indicator-ok {
            background-color: #28a745;
        }
        .indicator-warning {
            background-color: #ffc107;
        }
        .indicator-error {
            background-color: #dc3545;
        }
        .system-title {
            color: #495057;
            margin-bottom: 2rem;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 1rem;
        }
        .log-window {
            background-color: #212529;
            color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 5px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-info {
            color: #17a2b8;
        }
        .log-warning {
            color: #ffc107;
        }
        .log-error {
            color: #dc3545;
        }
        .progress {
            height: 25px;
            margin-bottom: 10px;
        }
        .progress-bar {
            line-height: 25px;
            font-weight: bold;
        }
        .refresh-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .uptime-info {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center system-title">Panel de Estado del Sistema</h1>
        
        <div class="row mb-4">
            <div class="col-md-12 text-center">
                <p id="currentTime" class="lead"></p>
                <p id="uptime" class="uptime-info"></p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="status-card">
                    <div id="server-status" class="card-header status-neutral">
                        <span class="status-indicator"></span> Estado del Servidor
                    </div>
                    <div class="card-body">
                        <p id="server-message">Cargando información del servidor...</p>
                        <small class="text-muted">Última actualización: <span id="server-time">-</span></small>
                    </div>
                </div>
                
                <div class="status-card">
                    <div id="database-status" class="card-header status-neutral">
                        <span class="status-indicator"></span> Base de Datos
                    </div>
                    <div class="card-body">
                        <p id="database-message">Cargando información de la base de datos...</p>
                        <small class="text-muted">Última actualización: <span id="database-time">-</span></small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="status-card">
                    <div id="scraper-status" class="card-header status-neutral">
                        <span class="status-indicator"></span> Sistema de Scraping
                    </div>
                    <div class="card-body">
                        <p id="scraper-message">Cargando información del scraper...</p>
                        <small class="text-muted">Última actualización: <span id="scraper-time">-</span></small>
                    </div>
                </div>
                
                <div class="status-card">
                    <div id="scheduler-status" class="card-header status-neutral">
                        <span class="status-indicator"></span> Tareas Programadas
                    </div>
                    <div class="card-body">
                        <p id="scheduler-message">Cargando información del programador...</p>
                        <small class="text-muted">Última actualización: <span id="scheduler-time">-</span></small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card status-card">
                    <div class="card-header status-neutral">
                        Uso de Recursos del Sistema
                    </div>
                    <div class="card-body">
                        <h6>Memoria RAM</h6>
                        <div class="progress">
                            <div id="memory-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        
                        <h6 class="mt-3">Espacio en Disco</h6>
                        <div class="progress">
                            <div id="disk-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card status-card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="logTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="server-log-tab" data-bs-toggle="tab" data-bs-target="#server-log" type="button" role="tab" aria-controls="server-log" aria-selected="true">Servidor</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="scraper-log-tab" data-bs-toggle="tab" data-bs-target="#scraper-log" type="button" role="tab" aria-controls="scraper-log" aria-selected="false">Scraper</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="monitor-log-tab" data-bs-toggle="tab" data-bs-target="#monitor-log" type="button" role="tab" aria-controls="monitor-log" aria-selected="false">Monitor</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="logTabsContent">
                            <div class="tab-pane fade show active" id="server-log" role="tabpanel" aria-labelledby="server-log-tab">
                                <div class="log-window" id="server-log-content">
                                    <div class="log-entry log-info">Cargando logs del servidor...</div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="scraper-log" role="tabpanel" aria-labelledby="scraper-log-tab">
                                <div class="log-window" id="scraper-log-content">
                                    <div class="log-entry log-info">Cargando logs del scraper...</div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="monitor-log" role="tabpanel" aria-labelledby="monitor-log-tab">
                                <div class="log-window" id="monitor-log-content">
                                    <div class="log-entry log-info">Cargando logs del monitor...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4 mb-5">
            <div class="col-md-12">
                <div class="card status-card">
                    <div class="card-header">
                        Acciones de Mantenimiento
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <button id="btn-maintenance" class="btn btn-primary w-100">Ejecutar Mantenimiento</button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button id="btn-backup" class="btn btn-success w-100">Crear Backup</button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button id="btn-optimize" class="btn btn-warning w-100">Optimizar BD</button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button id="btn-restart" class="btn btn-danger w-100">Reiniciar Sistema</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button id="refresh-btn" class="btn btn-primary btn-lg refresh-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
        </svg>
        Actualizar
    </button>
    
    <!-- Modal de acción -->
    <div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionModalLabel">Ejecutando acción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="action-message">Procesando...</p>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Función para actualizar la hora actual
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 'Fecha y hora actual: ' + now.toLocaleString();
            setTimeout(updateCurrentTime, 1000);
        }
        updateCurrentTime();
        
        // Función para actualizar el estado del sistema
        function updateSystemStatus() {
            // En una implementación real, esto sería una llamada a la API
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Actualizar estado del servidor
                    updateComponentStatus('server', data.status.server);
                    
                    // Actualizar estado de la base de datos
                    updateComponentStatus('database', data.status.database);
                    
                    // Actualizar estado del scraper
                    updateComponentStatus('scraper', data.status.scraper);
                    
                    // Actualizar estado del scheduler
                    updateComponentStatus('scheduler', data.status.scheduler);
                    
                    // Actualizar barras de progreso
                    updateProgressBar('memory', data.status.memory_usage);
                    updateProgressBar('disk', data.status.disk_usage);
                    
                    // Actualizar tiempo de actividad
                    const uptime = data.status.uptime;
                    const days = Math.floor(uptime / 1440);
                    const hours = Math.floor((uptime % 1440) / 60);
                    const minutes = Math.floor(uptime % 60);
                    document.getElementById('uptime').textContent = `Tiempo de actividad: ${days}d ${hours}h ${minutes}m`;
                    
                    // Actualizar última hora de actualización
                    const now = new Date().toLocaleTimeString();
                    document.getElementById('server-time').textContent = now;
                    document.getElementById('database-time').textContent = now;
                    document.getElementById('scraper-time').textContent = now;
                    document.getElementById('scheduler-time').textContent = now;
                })
                .catch(error => {
                    console.error('Error al obtener el estado del sistema:', error);
                });
        }
        
        // Función para actualizar el estado de un componente
        function updateComponentStatus(component, status) {
            const statusElement = document.getElementById(`${component}-status`);
            const messageElement = document.getElementById(`${component}-message`);
            const indicatorElement = statusElement.querySelector('.status-indicator');
            
            // Eliminar clases de estado anteriores
            statusElement.classList.remove('status-ok', 'status-warning', 'status-error', 'status-neutral');
            indicatorElement.classList.remove('indicator-ok', 'indicator-warning', 'indicator-error');
            
            // Establecer nuevas clases según el estado
            if (status === true) {
                statusElement.classList.add('status-ok');
                indicatorElement.classList.add('indicator-ok');
                messageElement.textContent = `El ${component} está funcionando correctamente.`;
            } else {
                statusElement.classList.add('status-error');
                indicatorElement.classList.add('indicator-error');
                messageElement.textContent = `El ${component} no está funcionando correctamente.`;
            }
        }
        
        // Función para actualizar barras de progreso
        function updateProgressBar(type, value) {
            const bar = document.getElementById(`${type}-bar`);
            bar.style.width = `${value}%`;
            bar.textContent = `${value}%`;
            bar.setAttribute('aria-valuenow', value);
            
            // Establecer color según el valor
            bar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
            if (value < 70) {
                bar.classList.add('bg-success');
            } else if (value < 90) {
                bar.classList.add('bg-warning');
            } else {
                bar.classList.add('bg-danger');
            }
        }
        
        // Función para cargar logs
        function loadLogs(type) {
            fetch(`/api/logs/${type}`)
                .then(response => response.json())
                .then(data => {
                    const logContent = document.getElementById(`${type}-log-content`);
                    logContent.innerHTML = '';
                    
                    data.logs.forEach(log => {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry';
                        
                        // Detectar tipo de log por contenido
                        if (log.includes('ERROR') || log.includes('CRITICAL')) {
                            logEntry.classList.add('log-error');
                        } else if (log.includes('WARNING')) {
                            logEntry.classList.add('log-warning');
                        } else {
                            logEntry.classList.add('log-info');
                        }
                        
                        logEntry.textContent = log;
                        logContent.appendChild(logEntry);
                    });
                    
                    // Scroll al final
                    logContent.scrollTop = logContent.scrollHeight;
                })
                .catch(error => {
                    console.error(`Error al cargar logs de ${type}:`, error);
                    document.getElementById(`${type}-log-content`).innerHTML = 
                        `<div class="log-entry log-error">Error al cargar logs: ${error.message}</div>`;
                });
        }
        
        // Evento para el botón de actualización
        document.getElementById('refresh-btn').addEventListener('click', function() {
            updateSystemStatus();
            loadLogs('server');
            loadLogs('scraper');
            loadLogs('monitor');
        });
        
        // Eventos para las pestañas de logs
        document.getElementById('server-log-tab').addEventListener('click', function() {
            loadLogs('server');
        });
        
        document.getElementById('scraper-log-tab').addEventListener('click', function() {
            loadLogs('scraper');
        });
        
        document.getElementById('monitor-log-tab').addEventListener('click', function() {
            loadLogs('monitor');
        });
        
        // Eventos para botones de acción
        document.getElementById('btn-maintenance').addEventListener('click', function() {
            executeAction('maintenance', 'Ejecutando mantenimiento de la base de datos...');
        });
        
        document.getElementById('btn-backup').addEventListener('click', function() {
            executeAction('backup', 'Creando copia de seguridad...');
        });
        
        document.getElementById('btn-optimize').addEventListener('click', function() {
            executeAction('optimize', 'Optimizando base de datos...');
        });
        
        document.getElementById('btn-restart').addEventListener('click', function() {
            if (confirm('¿Estás seguro de que deseas reiniciar el sistema? Se interrumpirán todas las operaciones en curso.')) {
                executeAction('restart', 'Reiniciando sistema...');
            }
        });
        
        // Función para ejecutar acciones
        function executeAction(action, message) {
            const actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
            document.getElementById('action-message').textContent = message;
            actionModal.show();
            
            fetch(`/api/admin/${action}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('action-message').textContent = data.message;
                setTimeout(() => {
                    actionModal.hide();
                    updateSystemStatus();
                }, 2000);
            })
            .catch(error => {
                document.getElementById('action-message').textContent = `Error: ${error.message}`;
                setTimeout(() => {
                    actionModal.hide();
                }, 3000);
            });
        }
        
        // Inicializar datos
        updateSystemStatus();
        loadLogs('server');
    </script>
</body>
</html>
